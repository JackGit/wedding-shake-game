<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link type="text/css" rel="stylesheet" href="static/font-awesome/font-awesome.min.css">
    <link type="text/css" rel="stylesheet" href="static/materialize/css/materialize.min.css"  media="screen,projection"/>

    <title>Monitor</title>
    <style>
        #d3Container {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 25%;
            background: lightcoral;
        }

        #dashboard {
            position: fixed;
            top: 0;
            left: 75%;
            bottom: 0;
            right: 0;
            background: lightgray;
        }
    </style>
</head>
<body class="grey lighten-4">


    <div id="d3Container"></div>
    <div id="dashboard">
        <div class="row">
            <label>加入人数</label>
            <h1>87</h1>
        </div>
        <div class="row">
            <label>游戏时间</label>
            <h1>00:15.0</h1>
        </div>
    </div>


    <script src="static/javascripts/jquery-2.1.1.min.js"></script>
    <script src="static/javascripts/wy.lib.js"></script>
    <script src="static/materialize/js/materialize.min.js"></script>
    <script src="static/javascripts/d3.v3.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>


    <script>
        var svg;
        var force;
        var nodes = [];
        var node;
        var PageAPI = {
            init: init,
            join: join,
            leave: leave,
            shake: shake,
            clear: clear
        };

        var count = 0;
        var id = 0;
        var users = [];
        var imgs = [
            'http://wedding.jackyang.me/static/images/groom_avatar.jpg',
            'http://wedding.jackyang.me/static/images/bride_avatar.jpg',
            'https://avatars3.githubusercontent.com/u/2811378?v=3&s=40',
            'https://avatars3.githubusercontent.com/u/11800556?v=3&s=192',
            'https://avatars3.githubusercontent.com/u/7535458?v=3&s=192',
            'https://avatars1.githubusercontent.com/u/2313263?v=3&s=192',
            'https://avatars3.githubusercontent.com/u/17906142?v=3&s=192',
            'https://avatars2.githubusercontent.com/u/5357393?v=3&s=192',
            'https://avatars0.githubusercontent.com/u/13914742?v=3&s=192',
            'https://avatars1.githubusercontent.com/u/8717459?v=3&s=192',
            'https://avatars0.githubusercontent.com/u/16396077?v=3&s=192',
            'https://avatars2.githubusercontent.com/u/953478?v=3&s=192',
            'https://avatars3.githubusercontent.com/u/8471550?v=3&s=192',
            'https://avatars3.githubusercontent.com/u/9475842?v=3&s=192'
        ];

        for(var i = 0; i < 100; i ++) {
            users.push({
                objectId: 'user_' + i,
                avatarImageUrl: imgs[wy.base.Util.random(0, imgs.length)],
                shakeCount: 50
            })
        }

        $(document).ready(function() {

            init();

            id = setInterval(function() {
                if(count < users.length)
                    join(users[count]);
                else
                    clearInterval(id);

                count ++;
            }, 100);
        });

        function init() {
            var $container = $('#d3Container');
            var w = $container.width();
            var h = $container.height();

            svg = d3.select("#d3Container")
                    .append("svg")
                    .attr("width", w)
                    .attr("height", h);

            force = d3.layout.force()
                    .charge(function(d) {return d.shakeCount * d.shakeCount / -24;})
                    .nodes(nodes)
                    .links([])
                    .size([w, h]);

            force.on("tick", onForceTick);
        }

        function onForceTick() {
            svg.selectAll(".node")
                    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
        }

        function updateForce() {
            force.nodes(nodes).start();

            node = svg
                    .selectAll(".node")
                    .data(nodes, function(d) {
                        return d.objectId;
                    });

            var g = node
                    .enter()
                    .append("g")
                    .attr("class", "node")
                    .call(force.drag);

            var pattern = g.append("defs").append('pattern')
                    .attr('id', function(d) {return 'p' + d.objectId;})
                    .attr('patternUnits', 'userSpaceOnUse')
                    .attr('x', function(d) {return d.shakeCount/-2})
                    .attr('y', function(d) {return d.shakeCount/-2})
                    .attr('width', function(d) {return d.shakeCount})
                    .attr('height', function(d) {return d.shakeCount});

            var image = pattern.append('image')
                    .attr('id', function(d) {return 'i' + d.objectId;})
                    .attr("xlink:href", function(d) {return d.avatarImageUrl})
                    .attr("width", function(d) {return d.shakeCount;})
                    .attr("height", function(d) {return d.shakeCount;});

            var circle = g.append("circle")
                    .attr('id', function(d) {return 'c' + d.objectId;})
                    .attr('r', function(d) {return d.shakeCount/2})
                    .attr('fill', function(d) {return 'url(#p' + d.objectId + ')'});

            node.exit().remove();
        }

        function join(user) {
            nodes.push({
                objectId: user.objectId,
                avatarImageUrl: user.avatarImageUrl,
                shakeCount: user.shakeCount
            });

            updateForce();
        }

        function leave(objectId) {
            nodes = nodes.filter(function(n) {
                return n.objectId !== objectId;
            });

            updateForce();
        }

        function shake(objectId, count) {
            node.select('#p' + objectId)
                    .attr('x', count/-2)
                    .attr('y', count/-2)
                    .attr('width', count)
                    .attr('height', count);

            node.select('#i' + objectId)
                    .attr('width', count)
                    .attr('height', count);

            node.select('#c' + objectId)
                    .attr('r', count/2);

            force.start();
        }

        function clear() {
            nodes = [];
            updateForce();
        }



        function initSocket() {
            socket = io();

            socket.on('join', function(userId) {
                so.push({type: 'join', data: userId});
            });

            socket.on('leave', function(userId) {
                so.push({type: 'leave', data: userId});
            });

            socket.on('shake', function(message) {
                so.push({type: 'shake', data: message});
            });

            socket.on('status-change', function(message) {
                var roomId = message.roomId;
                var status = message.status;

                switch(status) {
                    case 'JOINING':
                        onSocketMessage(['join', 'leave']);
                        offSocketMessage(['shake']);
                        break;
                    case 'PLAYING':
                        onSocketMessage(['shake']);
                        offSocketMessage(['join', 'leave']);
                        break;
                    case 'END':
                        offSocketMessage(['join', 'leave', 'shake']);
                        break;
                    default:
                        break;
                }
            });
        }

        function onSocketMessage(type) {
            if(typeof type === 'string')
                type = [type];

            type.forEach(function(t) {
                socket.on(t, function(message) {
                    proxyMessageToSteadyOutput(t, message);
                });
            })
        }

        function offSocketMessage(type) {
            if(typeof type === 'string')
                type = [type];

            type.forEach(function(t) {
                socket.off(t);
            });
        }

        function proxyMessageToSteadyOutput(type, message) {
            so.push({type: 'shake', data: message});
        }

        function initSteadyOutput() {
            so = new wy.base.SteadyOutput({
                interval: 100
            });

            so.register(function(message) {
                switch(message.type) {
                    case 'join':
                        break;
                    case 'leave':
                        break;
                    case 'shake':
                        break;
                    case 'status-change':
                        break;
                    default:
                        break;
                }
            });
        }

    </script>
</body>
</html>